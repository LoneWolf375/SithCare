<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Agendar consulta m√©dica - SithCare</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">

  <style>
    :root{
      --bg-1:#0b1020; --bg-2:#111832; --card:rgba(12,16,34,.65);
      --text:#eef2ff; --muted:#9aa3c7; --brand:#6b8bff; --brand-2:#8aa0ff;
      --border:rgba(226,232,240,.14); --ring:rgba(107,139,255,.45);
      --shadow:0 12px 36px rgba(0,0,0,.5);
      --chip:#1f2a44; --chip-border:#334155; --chip-active:#2139ff1a;

      /* Paleta estados (oscuro) */
      --avail:#22c55e; --avail-2:#16a34a; --avail-bg:#0a2a18;
      --occ-text:#94a3b8; --occ-bg:#0f172a; --occ-border:#334155;
      --past-text:#64748b; --past-bg:#0b1220;
    }
    @media (prefers-color-scheme: light){
      :root{
        --bg-1:#eef3ff; --bg-2:#f7f9ff; --card:rgba(255,255,255,.9);
        --text:#0f172a; --muted:#475569; --brand:#2e5bff; --brand-2:#6b7bff;
        --border:rgba(30,41,59,.12); --ring:rgba(46,91,255,.35);
        --shadow:0 12px 36px rgba(31,38,135,.18);
        --chip:#f1f5f9; --chip-border:#cbd5e1; --chip-active:#2e5bff12;

        /* Paleta estados (claro) */
        --avail:#16a34a; --avail-2:#22c55e; --avail-bg:#e8f9ee;
        --occ-text:#475569; --occ-bg:#f1f5f9; --occ-border:#cbd5e1;
        --past-text:#64748b; --past-bg:#f8fafc;
      }
    }

    html,body{height:100%}
    body{
      margin:0; font-family: system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif; color:var(--text);
      display:grid; place-items:center; padding:24px;
      background:
        radial-gradient(1000px 700px at 12% 8%, var(--bg-2) 0%, transparent 60%),
        radial-gradient(1000px 700px at 88% 92%, var(--bg-2) 0%, transparent 60%),
        linear-gradient(160deg, var(--bg-1) 0%, var(--bg-2) 100%);
    }

    .wrap{
      width:min(96vw, 720px);
      background:var(--card); backdrop-filter: blur(10px);
      border:1px solid var(--border); border-radius:24px;
      box-shadow:var(--shadow); padding:28px 24px;
    }

    h2{ font-weight:800; margin:0 0 18px; text-align:center; }
    .hint{ color:var(--muted); font-size:.95rem; }

    /* Chatbot box */
    #chatbot{
      background: linear-gradient(180deg, var(--chip), transparent);
      border:1px solid var(--border);
      border-left:4px solid var(--brand);
      border-radius:14px; padding:14px 16px; color:var(--text);
      box-shadow: inset 0 1px 0 rgba(255,255,255,.04);
    }

    /* Inputs */
    .form-label{ font-weight:600; }
    #fecha.form-control{
      background:rgba(255,255,255,.08); color:var(--text);
      border:1px solid var(--border); border-radius:12px; padding:.7rem .9rem;
    }
    #fecha.form-control:focus{ box-shadow:0 0 0 .35rem var(--ring); border-color:transparent; }

    /* Contenedor horas */
    #horas-container{ border:1px solid var(--border); border-radius:16px; padding:16px; background:rgba(255,255,255,.03); }
    #horas-lista{ display:flex; flex-direction:column; gap:10px; margin:0; padding:0; list-style:none; }

    /* Base de cada slot (evita usar estilos inline) */
    .slot{
      display:block;
      margin:0;
      padding:.55rem .9rem;
      border-radius:999px;
      line-height:1.2;
    }

    /* Disponible: verde */
    .hora-disponible{
      cursor:pointer; user-select:none;
      background: var(--avail-bg);
      border:1px solid rgba(34,197,94,.55);
      color:var(--text); transition: all .15s ease;
    }
    .hora-disponible:hover{ transform:translateY(-1px); box-shadow:0 8px 18px rgba(0,0,0,.15); }
    .hora-disponible.selected{
      background: linear-gradient(180deg, rgba(34,197,94,.15), rgba(34,197,94,.08));
      border-color: var(--avail);
      box-shadow:0 0 0 .18rem rgba(34,197,94,.35);
    }

    /* Ocupado: gris */
    .hora-ocupada{
      pointer-events: none; cursor: not-allowed;
      background: var(--occ-bg);
      border:1px solid var(--occ-border);
      color: var(--occ-text);
      opacity:.9;
    }

    /* Pasado (hoy): gris oscuro dashed + tachado leve */
    .hora-pasada{
      pointer-events: none; cursor: not-allowed;
      background: var(--past-bg);
      border:1px dashed var(--occ-border);
      color: var(--past-text);
      text-decoration: line-through;
      opacity:.85;
    }

    /* Bot√≥n primario */
    .btn-primary{
      background:linear-gradient(180deg,var(--brand),var(--brand-2)); border:none;
      font-weight:700; border-radius:12px; padding:.8rem 1rem;
      box-shadow:0 12px 28px rgba(46,91,255,.25);
    }
    .btn-primary:focus{ box-shadow:0 0 0 .35rem var(--ring); }

    /* Modal */
    .modal-content{ background:var(--card); color:var(--text); border:1px solid var(--border); }
    .btn-secondary{ background:transparent; color:var(--muted); border:1px solid var(--border); }
    .btn-secondary:hover{ color:var(--text); }

    /* Badges de la leyenda */
    .badge-disponible{
      background: linear-gradient(180deg, rgba(34,197,94,.95), rgba(22,163,74,.95));
    }
    .badge-ocupado{
      background: var(--occ-border);
    }
    .badge-pasado{
      background: var(--past-bg);
      color:#e2e8f0;
      border:1px dashed var(--occ-border);
    }
  </style>
</head>
<body>

  <main class="wrap">
    <h2>Agendar consulta m√©dica</h2>

    <div id="chatbot" class="mb-3">
      ü§ñ Tu triaje determin√≥ que <strong>no hay urgencia</strong>. Para continuar, <strong>agenda una consulta</strong>: haz clic en el <u>√≠cono del calendario</u> a la derecha del campo, elige la fecha y luego una hora disponible.
    </div>

    <label for="fecha" class="form-label">Selecciona una fecha</label>
    <input type="date" id="fecha" class="form-control mb-2">

    <!-- Leyenda -->
    <div class="mb-2">
      <span class="badge badge-disponible">Disponible</span>
      <span class="badge badge-ocupado">Ocupado</span>
      <span class="badge badge-pasado">Pasado (hoy)</span>
    </div>

    <div id="sugerencia" class="mb-3 hint border rounded-3 p-3" style="border-color:var(--border)!important; background:rgba(255,255,255,.03);">
      üïí Buscando la primera hora disponible‚Ä¶
    </div>

    <div id="horas-container" class="mt-2 d-none">
      <h5 class="mb-2">Opciones de agendamiento</h5>
      <ul id="horas-lista"></ul>
    </div>
  </main>

  <!-- Modal de confirmaci√≥n -->
  <div id="confirmacion-modal" class="modal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Confirmar Cita</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <p id="confirmacion-texto" class="mb-2"></p>
          <div class="hint"><strong>Motivo:</strong> <span id="confirmacion-motivo"></span></div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
          <button type="button" class="btn btn-primary" id="confirmar-btn">Aceptar</button>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    const fechaInput = document.getElementById("fecha");
    const horasContainer = document.getElementById("horas-container");
    const horasLista = document.getElementById("horas-lista");
    const sugerencia = document.getElementById("sugerencia");
    const confirmacionModal = new bootstrap.Modal(document.getElementById('confirmacion-modal'));
    const confirmarBtn = document.getElementById('confirmar-btn');

    let citaSeleccionada = { fecha: '', hora: '' };

    function formatearFechaLargo(fechaISO) {
      const opciones = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
      const [year, month, day] = fechaISO.split('-');
      return new Date(year, month - 1, day).toLocaleDateString('es-CL', opciones);
    }

    function mostrarError(mensaje) {
      horasLista.innerHTML = `<li class="slot hora-ocupada">${mensaje}</li>`;
      horasContainer.classList.remove("d-none");
    }

    document.addEventListener('DOMContentLoaded', () => {
      if (!localStorage.getItem("authToken")) {
        alert("Por favor, inicia sesi√≥n para agendar una cita.");
        window.location.href = "/login/";
        return;
      }

      const hoy = new Date();
      const yyyy = hoy.getFullYear();
      const mm = String(hoy.getMonth() + 1).padStart(2, '0');
      const dd = String(hoy.getDate()).padStart(2, '0');
      if (fechaInput) fechaInput.min = `${yyyy}-${mm}-${dd}`;

      cargarSugerenciaInicial();
    });

    function cargarSugerenciaInicial() {
      const token = localStorage.getItem("authToken");
      axios.get("http://127.0.0.1:8000/api/agendamiento/citas/sugerir/?limite_dias=30", {
        headers: { 'Authorization': `Token ${token}` }
      })
      .then(res => {
        const { fecha, hora } = res.data || {};
        if (fecha && hora) {
          const fechaLarga = formatearFechaLargo(fecha);
          sugerencia.innerHTML =
            `üïí <strong>Sugerencia:</strong> La pr√≥xima hora disponible es <strong>${hora}</strong> el <strong>${fechaLarga}</strong>. ` +
            `<button id="btn-usar-sugerencia" class="btn btn-sm btn-link p-0 ms-1">Usar esta sugerencia</button>`;
          document.getElementById('btn-usar-sugerencia').onclick = () => {
            fechaInput.value = fecha;
            fechaInput.dispatchEvent(new Event('change'));
          };
        } else {
          sugerencia.textContent = "No hay disponibilidad dentro de los pr√≥ximos 30 d√≠as.";
        }
      })
      .catch(err => {
        if (err.response && err.response.status === 401) {
          alert('Sesi√≥n expirada. Por favor, inicia sesi√≥n nuevamente.');
          localStorage.removeItem("authToken");
          localStorage.removeItem("usuario_id");
          window.location.href = "/login/";
          return;
        }
        const msg = err.response?.data?.error || "No se pudo obtener una sugerencia en este momento.";
        sugerencia.textContent = msg;
      });
    }

    // Helpers
    function esHoy(fechaISO){
      const d = new Date();
      const [y, mo, da] = fechaISO.split('-').map(Number);
      return d.getFullYear()===y && (d.getMonth()+1)===mo && d.getDate()===da;
    }
    function horaYaPasada(hhmm){
      const [H,M] = hhmm.split(':').map(Number);
      const ahora = new Date();
      const comp = new Date();
      comp.setHours(H, M, 0, 0);
      return comp.getTime() <= ahora.getTime();
    }
    function generarGrillaDia() {
      const res = [];
      let h = 9, m = 0;
      while (true) {
        const hh = String(h).padStart(2, '0');
        const mm = String(m).padStart(2, '0');
        res.push(`${hh}:${mm}`);
        m += 30;
        if (m === 60) { m = 0; h += 1; }
        if (h > 17 || (h === 17 && m === 30)) break; // hasta 17:30 inclusive
      }
      return res;
    }
    function padHora(hhmm) {
      if (!hhmm) return hhmm;
      const [h,m] = hhmm.split(':');
      return `${String(parseInt(h,10)).padStart(2,'0')}:${String(parseInt(m,10)).padStart(2,'0')}`;
    }

    fechaInput.addEventListener("change", () => {
      const fechaSeleccionada = fechaInput.value;
      const token = localStorage.getItem("authToken");
      if (!fechaSeleccionada) return mostrarError("Por favor, selecciona una fecha v√°lida.");

      axios.post("http://127.0.0.1:8000/api/agendamiento/citas/disponibilidad/", { fecha: fechaSeleccionada }, {
        headers: { 'Authorization': `Token ${token}` }
      })
      .then(response => {
        const horasDisponibles = new Set((response.data.horas_disponibles || []).map(padHora));
        const grilla = generarGrillaDia();

        horasLista.innerHTML = "";
        grilla.forEach(hora => {
          const li = document.createElement("li");
          li.textContent = hora;
          li.className = "slot";

          const disponible = horasDisponibles.has(padHora(hora));
          const pasado = esHoy(fechaSeleccionada) && horaYaPasada(hora);

          if (!disponible || pasado) {
            li.classList.add(pasado ? 'hora-pasada' : 'hora-ocupada');
            li.setAttribute('aria-disabled','true');
            li.tabIndex = -1;
          } else {
            li.classList.add('hora-disponible');
            li.setAttribute('role','button');
            li.tabIndex = 0;

            // Revalidaci√≥n antes del modal
            li.addEventListener("click", async () => {
              try {
                const resp = await axios.post(
                  "http://127.0.0.1:8000/api/agendamiento/citas/disponibilidad/",
                  { fecha: fechaSeleccionada },
                  { headers: { 'Authorization': `Token ${token}` } }
                );
                const disponiblesNow = new Set((resp.data.horas_disponibles || []).map(padHora));
                if (!disponiblesNow.has(padHora(hora))) {
                  li.classList.remove('hora-disponible','selected');
                  li.classList.add('hora-ocupada');
                  li.setAttribute('aria-disabled','true');
                  li.tabIndex = -1;
                  fechaInput.dispatchEvent(new Event('change'));
                  return;
                }

                document.querySelectorAll('.hora-disponible.selected').forEach(el => el.classList.remove('selected'));
                li.classList.add('selected');

                citaSeleccionada.fecha = fechaSeleccionada;
                citaSeleccionada.hora = hora;

                const fechaCompleta = formatearFechaLargo(fechaSeleccionada);
                document.getElementById('confirmacion-texto').innerText =
                  `Cita agendada para ${citaSeleccionada.hora} el ${fechaCompleta}`;

                const motivoPrev = sessionStorage.getItem('motivoPaciente') || 'No especificado';
                document.getElementById('confirmacion-motivo').textContent = motivoPrev;

                confirmacionModal.show();
              } catch (e) {
                sugerencia.textContent = "No se pudo revalidar la disponibilidad. Intenta de nuevo.";
              }
            });
          }

          horasLista.appendChild(li);
        });

        horasContainer.classList.remove("d-none");
      })
      .catch(error => {
        if (error.response && error.response.status === 401) {
          alert('Sesi√≥n expirada. Por favor, inicia sesi√≥n nuevamente.');
          localStorage.removeItem("authToken");
          localStorage.removeItem("usuario_id");
          window.location.href = "/login/";
          return;
        }
        if (error.response && error.response.status === 400) {
          const msg = error.response.data?.error || "Fecha inv√°lida.";
          return mostrarError(msg);
        }
        mostrarError("Ocurri√≥ un error al cargar las horas.");
      });
    });

    confirmarBtn.addEventListener('click', () => {
      const token = localStorage.getItem('authToken');
      const usuario_id = localStorage.getItem('usuario_id');
      if (!token || !usuario_id) {
        alert('Por favor, inicia sesi√≥n para agendar una cita.');
        window.location.href = '/login/';
        return;
      }

      const motivo = sessionStorage.getItem('motivoPaciente') || 'Consulta m√©dica agendada por chatbot';
      const data = {
        usuario_id: parseInt(usuario_id),
        fecha: citaSeleccionada.fecha,
        hora: citaSeleccionada.hora,
        motivo
      };

      axios.post("http://127.0.0.1:8000/api/agendamiento/citas/agendar/", data, {
        headers: { 'Authorization': `Token ${token}`, 'Content-Type': 'application/json' }
      })
      .then(() => {
        localStorage.setItem('fechaCita', citaSeleccionada.fecha);
        localStorage.setItem('horaCita', citaSeleccionada.hora);
        localStorage.setItem('motivoCita', motivo);
        sessionStorage.removeItem('motivoPaciente');
        window.location.href = `/cita_agendada/`;
      })
      .catch(error => {
        if (error.response) {
          const { status, data } = error.response;
          const backendMsg = data?.error || data?.message || "";
          if (status === 401) {
            localStorage.removeItem("authToken");
            localStorage.removeItem("usuario_id");
            window.location.href = "/login/";
            return;
          }
          if (status === 400) {
            const msgLow = (backendMsg || "").toLowerCase();
            if (msgLow.includes("ya est√° tomado")) {
              alert("Lo siento, esa hora ya est√° tomada. Por favor, elige otra hora.");
              fechaInput.dispatchEvent(new Event('change'));
            } else if (backendMsg) {
              alert(backendMsg);
            } else {
              alert("No pudimos agendar. Revisa la fecha y la hora.");
            }
            return;
          }
        }
        alert("Ocurri√≥ un error al agendar la cita. Por favor, verifica los datos o int√©ntalo de nuevo.");
      });

      confirmacionModal.hide();
    });
  </script>
</body>
</html>