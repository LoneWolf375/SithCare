<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Agendar consulta m√©dica - SithCare</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">

  <style>
    :root{
      --bg-1:#0b1020; --bg-2:#111832; --card:rgba(12,16,34,.65);
      --text:#eef2ff; --muted:#9aa3c7; --brand:#6b8bff; --brand-2:#8aa0ff;
      --border:rgba(226,232,240,.14); --ring:rgba(107,139,255,.45);
      --shadow:0 12px 36px rgba(0,0,0,.5);
      --ok:#22c55e; --ok-2:#16a34a;
      --chip:#1f2a44; --chip-border:#334155; --chip-active:#2139ff1a;
    }
    @media (prefers-color-scheme: light){
      :root{
        --bg-1:#eef3ff; --bg-2:#f7f9ff; --card:rgba(255,255,255,.9);
        --text:#0f172a; --muted:#475569; --brand:#2e5bff; --brand-2:#6b7bff;
        --border:rgba(30,41,59,.12); --ring:rgba(46,91,255,.35);
        --shadow:0 12px 36px rgba(31,38,135,.18);
        --chip:#f1f5f9; --chip-border:#cbd5e1; --chip-active:#2e5bff12;
      }
    }

    html,body{height:100%}
    body{
      margin:0; font-family: system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif; color:var(--text);
      display:grid; place-items:center; padding:24px;
      background:
        radial-gradient(1000px 700px at 12% 8%, var(--bg-2) 0%, transparent 60%),
        radial-gradient(1000px 700px at 88% 92%, var(--bg-2) 0%, transparent 60%),
        linear-gradient(160deg, var(--bg-1) 0%, var(--bg-2) 100%);
    }

    .wrap{
      width:min(96vw, 720px);
      background:var(--card); backdrop-filter: blur(10px);
      border:1px solid var(--border); border-radius:24px;
      box-shadow:var(--shadow); padding:28px 24px;
    }

    h2{ font-weight:800; margin:0 0 18px; text-align:center; }
    .hint{ color:var(--muted); font-size:.95rem; }

    /* Chatbot box */
    #chatbot{
      background: linear-gradient(180deg, var(--chip), transparent);
      border:1px solid var(--border);
      border-left:4px solid var(--brand);
      border-radius:14px; padding:14px 16px; color:var(--text);
      box-shadow: inset 0 1px 0 rgba(255,255,255,.04);
    }

    /* Inputs */
    .form-label{ font-weight:600; }
    #fecha.form-control{
      background:rgba(255,255,255,.08); color:var(--text);
      border:1px solid var(--border); border-radius:12px; padding:.7rem .9rem;
    }
    #fecha.form-control:focus{ box-shadow:0 0 0 .35rem var(--ring); border-color:transparent; }

    /* Lista de horas como ‚Äúchips‚Äù */
    #horas-container{ border:1px solid var(--border); border-radius:16px; padding:16px; background:rgba(255,255,255,.03); }
    #horas-lista{ display:flex; flex-wrap:wrap; gap:10px; margin:0; padding:0; list-style:none; }
    .hora-disponible{
      cursor:pointer; user-select:none;
      padding:.55rem .9rem; border-radius:999px;
      background:var(--chip); border:1px solid var(--chip-border);
      color:var(--text); transition: all .15s ease;
    }
    .hora-disponible:hover{ transform:translateY(-1px); box-shadow:0 8px 18px rgba(0,0,0,.15); }
    .hora-disponible.selected{
      background: var(--chip-active);
      border-color: var(--brand); box-shadow:0 0 0 .2rem var(--ring);
    }

    /* Bot√≥n primario */
    .btn-primary{
      background:linear-gradient(180deg,var(--brand),var(--brand-2)); border:none;
      font-weight:700; border-radius:12px; padding:.8rem 1rem;
      box-shadow:0 12px 28px rgba(46,91,255,.25);
    }
    .btn-primary:focus{ box-shadow:0 0 0 .35rem var(--ring); }

    /* Modal (hereda Bootstrap, solo color) */
    .modal-content{ background:var(--card); color:var(--text); border:1px solid var(--border); }
    .btn-secondary{ background:transparent; color:var(--muted); border:1px solid var(--border); }
    .btn-secondary:hover{ color:var(--text); }
  </style>
</head>
<body>

  <main class="wrap">
    <h2>Agendar consulta m√©dica</h2>

    <div id="chatbot" class="mb-3">
      ü§ñ Tu triaje determin√≥ que <strong>no hay urgencia</strong>. Para continuar, <strong>agenda una consulta</strong>: haz clic en el <u>√≠cono del calendario</u> a la derecha del campo, elige la fecha y luego una hora disponible.
    </div>

    <label for="fecha" class="form-label">Selecciona una fecha</label>
    <input type="date" id="fecha" class="form-control mb-3">

    <div id="sugerencia" class="mb-3 hint border rounded-3 p-3" style="border-color:var(--border)!important; background:rgba(255,255,255,.03);">
      üïí Buscando la primera hora disponible‚Ä¶
    </div>

    <div id="horas-container" class="mt-2 d-none">
      <h5 class="mb-2">Opciones de agendamiento</h5>
      <ul id="horas-lista" class="list-group"></ul>
    </div>
  </main>

  <!-- Modal de confirmaci√≥n -->
  <div id="confirmacion-modal" class="modal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Confirmar Cita</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <p id="confirmacion-texto" class="mb-2"></p>
          <div class="hint"><strong>Motivo:</strong> <span id="confirmacion-motivo"></span></div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
          <button type="button" class="btn btn-primary" id="confirmar-btn">Aceptar</button>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    const fechaInput = document.getElementById("fecha");
    const horasContainer = document.getElementById("horas-container");
    const horasLista = document.getElementById("horas-lista");
    const sugerencia = document.getElementById("sugerencia");
    const confirmacionModal = new bootstrap.Modal(document.getElementById('confirmacion-modal'));
    const confirmarBtn = document.getElementById('confirmar-btn');
    const chatbotBox = document.getElementById('chatbot');
    let citaSeleccionada = { fecha: '', hora: '' };
    let sugerenciaGlobal = null;

    function formatearFechaLargo(fechaISO) {
      const opciones = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
      const [year, month, day] = fechaISO.split('-');
      return new Date(year, month - 1, day).toLocaleDateString('es-CL', opciones);
    }

    function mostrarError(mensaje) {
      horasLista.innerHTML = `<li class='list-group-item text-danger bg-transparent border-0 ps-0'>${mensaje}</li>`;
      horasContainer.classList.remove("d-none");
    }

    document.addEventListener('DOMContentLoaded', () => {
      if (!localStorage.getItem("authToken")) {
        alert("Por favor, inicia sesi√≥n para agendar una cita.");
        window.location.href = "/login/";
        return;
      }

      const hoy = new Date();
      const yyyy = hoy.getFullYear();
      const mm = String(hoy.getMonth() + 1).padStart(2, '0');
      const dd = String(hoy.getDate()).padStart(2, '0');
      if (fechaInput) fechaInput.min = `${yyyy}-${mm}-${dd}`;

      cargarSugerenciaInicial();
    });

    function cargarSugerenciaInicial() {
      const token = localStorage.getItem("authToken");
      axios.get("http://127.0.0.1:8000/api/agendamiento/citas/sugerir/?limite_dias=30", {
        headers: { 'Authorization': `Token ${token}` }
      })
      .then(res => {
        const { fecha, hora } = res.data || {};
        if (fecha && hora) {
          sugerenciaGlobal = { fecha, hora };
          const fechaLarga = formatearFechaLargo(fecha);
          sugerencia.innerHTML =
            `üïí <strong>Sugerencia:</strong> La pr√≥xima hora disponible es <strong>${hora}</strong> el <strong>${fechaLarga}</strong>. ` +
            `<button id="btn-usar-sugerencia" class="btn btn-sm btn-link p-0 ms-1">Usar esta sugerencia</button>`;

          document.getElementById('btn-usar-sugerencia').onclick = () => {
            fechaInput.value = fecha;
            fechaInput.dispatchEvent(new Event('change'));
          };
        } else {
          sugerencia.textContent = "No hay disponibilidad dentro de los pr√≥ximos 30 d√≠as.";
        }
      })
      .catch(err => {
        if (err.response && err.response.status === 401) {
          alert('Sesi√≥n expirada. Por favor, inicia sesi√≥n nuevamente.');
          localStorage.removeItem("authToken");
          localStorage.removeItem("usuario_id");
          window.location.href = "/login/";
          return;
        }
        const msg = err.response?.data?.error || "No se pudo obtener una sugerencia en este momento.";
        sugerencia.textContent = msg;
      });
    }

    fechaInput.addEventListener("change", () => {
      const fechaSeleccionada = fechaInput.value;
      const token = localStorage.getItem("authToken");

      if (!fechaSeleccionada) {
        mostrarError("Por favor, selecciona una fecha v√°lida.");
        return;
      }

      axios.post("http://127.0.0.1:8000/api/agendamiento/citas/disponibilidad/", {
        fecha: fechaSeleccionada
      }, {
        headers: { 'Authorization': `Token ${token}` }
      })
      .then(response => {
        const horas = response.data.horas_disponibles;
        if (horas && horas.length > 0) {
          horasLista.innerHTML = "";
          horas.forEach(hora => {
            const item = document.createElement("li");
            item.className = "list-group-item hora-disponible";
            item.innerText = hora;
            item.style.background = "transparent";
            item.style.border = "none";

            item.onclick = () => {
              document.querySelectorAll('.hora-disponible').forEach(el => el.classList.remove('selected'));
              item.classList.add('selected');

              citaSeleccionada.fecha = fechaSeleccionada;
              citaSeleccionada.hora = hora;

              const fechaCompleta = formatearFechaLargo(fechaSeleccionada);
              document.getElementById('confirmacion-texto').innerText =
                `Cita agendada para ${citaSeleccionada.hora} el ${fechaCompleta}`;
            
              const motivoPrev = sessionStorage.getItem('motivoPaciente') || 'No especificado';
              document.getElementById('confirmacion-motivo').textContent = motivoPrev;

              confirmacionModal.show();
            };
            horasLista.appendChild(item);
          });
          horasContainer.classList.remove("d-none");
        } else {
          mostrarError("No hay cupos disponibles para esta fecha.");
        }
      })
      .catch(error => {
        if (error.response && error.response.status === 401) {
          alert('Sesi√≥n expirada. Por favor, inicia sesi√≥n nuevamente.');
          localStorage.removeItem("authToken");
          localStorage.removeItem("usuario_id");
          window.location.href = "/login/";
          return;
        }

        if (error.response && error.response.status === 400) {
          const msg = error.response.data?.error || "Fecha inv√°lida.";
          mostrarError(msg);
          return;
        }

        mostrarError("Ocurri√≥ un error al cargar las horas.");
      });
    });

    confirmarBtn.addEventListener('click', () => {
      const token = localStorage.getItem('authToken');
      const usuario_id = localStorage.getItem('usuario_id');

      if (!token || !usuario_id) {
        alert('Por favor, inicia sesi√≥n para agendar una cita.');
        window.location.href = '/login/';
        return;
      }

      const motivo = sessionStorage.getItem('motivoPaciente') || 'Consulta m√©dica agendada por chatbot';

      const data = {
        usuario_id: parseInt(usuario_id),
        fecha: citaSeleccionada.fecha,
        hora: citaSeleccionada.hora,
        motivo: motivo
      };

      axios.post("http://127.0.0.1:8000/api/agendamiento/citas/agendar/", data, {
        headers: {
          'Authorization': `Token ${token}`,
          'Content-Type': 'application/json'
        }
      })
      .then(() => {
        localStorage.setItem('fechaCita', citaSeleccionada.fecha);
        localStorage.setItem('horaCita', citaSeleccionada.hora);
        localStorage.setItem('motivoCita', motivo);
        sessionStorage.removeItem('motivoPaciente');
        window.location.href = `/cita_agendada/`;
      })
      .catch(error => {
        if (error.response) {
          const { status, data } = error.response;
          const backendMsg = data?.error || data?.message || "";

          if (status === 401) {
            localStorage.removeItem("authToken");
            localStorage.removeItem("usuario_id");
            window.location.href = "/login/";
            return;
          }

          if (status === 400) {
            const msgLow = (backendMsg || "").toLowerCase();
            if (msgLow.includes("ya est√° tomado")) {
              alert("Lo siento, esa hora ya est√° tomada. Por favor, elige otra hora.");
            } else if (backendMsg) {
              alert(backendMsg);
            } else {
              alert("No pudimos agendar. Revisa la fecha y la hora.");
            }
            return;
          }
        }

        alert("Ocurri√≥ un error al agendar la cita. Por favor, verifica los datos o int√©ntalo de nuevo.");
      });

      confirmacionModal.hide();
    });
  </script>
</body>
</html>