{% load static %}
<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>SithCare – Iniciar sesión</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">

  <style>
    :root{
      --bg-1:#eef3ff; --bg-2:#f7f9ff; --card:rgba(255,255,255,.78);
      --text:#1c1f27; --muted:#5a6275; --brand:#2e5bff; --brand-2:#6b7bff;
      --border:rgba(30,41,59,.12); --ring:rgba(46,91,255,.35);
      --shadow:0 12px 36px rgba(31,38,135,.18);
    }
    @media (prefers-color-scheme: dark){
      :root{
        --bg-1:#0b1020; --bg-2:#111832; --card:rgba(12,16,34,.65);
        --text:#eef2ff; --muted:#9aa3c7; --brand:#6b8bff; --brand-2:#8aa0ff;
        --border:rgba(226,232,240,.14); --ring:rgba(107,139,255,.45);
        --shadow:0 12px 36px rgba(0,0,0,.5);
      }
    }

    html,body{height:100%}
    body{
      margin:0; font-family:'Inter',system-ui,Segoe UI,Roboto,Arial,sans-serif; color:var(--text);
      display:grid; place-items:center; padding:24px;
      background:
        radial-gradient(1000px 700px at 12% 8%, var(--bg-2) 0%, transparent 60%),
        radial-gradient(1000px 700px at 88% 92%, var(--bg-2) 0%, transparent 60%),
        linear-gradient(160deg, var(--bg-1) 0%, var(--bg-2) 100%);
    }
    .card-glass{
      width:min(96vw, 480px);
      background:var(--card); backdrop-filter: blur(10px);
      border:1px solid var(--border); border-radius:24px;
      box-shadow:var(--shadow); padding:28px 24px;
    }
    .brand{
      display:flex; align-items:center; gap:12px; margin-bottom:10px; justify-content:center;
    }
    .brand img{ width:44px; height:44px; border-radius:10px; }
    .brand h1{ font-size:22px; font-weight:800; margin:0; letter-spacing:.2px; }
    .subtitle{ color:var(--muted); margin:0 0 18px; font-size:14px; text-align:center;}

    .form-floating>.form-control, .form-floating>.form-control:focus{
      background:rgba(255,255,255,.55);
    }
    @media (prefers-color-scheme: dark){
      .form-floating>.form-control, .form-floating>.form-control:focus{
        background:rgba(15,20,42,.55); color:var(--text);
      }
      .form-control::placeholder{ color:#8ea0c7; }
    }

    .btn-brand{
      background:linear-gradient(180deg,var(--brand),var(--brand-2)); border:none;
      font-weight:700; padding:.9rem 1rem; border-radius:14px;
      box-shadow:0 12px 28px rgba(46,91,255,.25);
    }
    .btn-brand:focus{ box-shadow:0 0 0 .35rem var(--ring); }
    .btn-ghost{
      background:transparent; color:var(--brand); border:1px solid var(--brand);
      border-radius:12px; font-weight:600;
    }

    .toggle-pass{
      position:absolute; right:12px; top:50%; transform:translateY(-50%);
      border:none; background:transparent; padding:6px; line-height:0; cursor:pointer;
    }
    /* Ojo visible y claro */
    .toggle-pass svg path,
    .toggle-pass svg circle{
      stroke:#cfd8ff; transition:stroke .2s ease;
    }
    .toggle-pass:hover svg path,
    .toggle-pass:hover svg circle{ stroke:#ffffff; }

    .is-invalid + .invalid-feedback{ display:block; }
  </style>
</head>
<body>

  <main class="card-glass">
    <div class="brand">
      <img src="{% static 'assets/img/sithcare_logo.PNG' %}" alt="SithCare">
      <h1>Iniciar sesión</h1>
    </div>
    <p class="subtitle">Bienvenido nuevamente. Ingresa con tu RUT y contraseña.</p>

    <div class="vstack gap-3" id="loginForm">
      <div class="form-floating">
        <input id="rut" type="text" class="form-control" placeholder="12345678-K" autocomplete="username">
        <label for="rut">RUT (ej: 12345678-K)</label>
        <div class="invalid-feedback">Ingresa un RUT válido.</div>
      </div>

      <div class="position-relative form-floating">
        <input id="password" type="password" class="form-control" placeholder="Contraseña" autocomplete="current-password">
        <label for="password">Contraseña</label>
        <button class="toggle-pass" type="button" aria-label="Mostrar u ocultar contraseña" data-target="password">
          <svg width="22" height="22" viewBox="0 0 24 24" fill="none"><path d="M1.5 12S5 5 12 5s10.5 7 10.5 7-3.5 7-10.5 7S1.5 12 1.5 12Z" stroke="currentColor" stroke-width="1.5"/><circle cx="12" cy="12" r="3.5" stroke="currentColor" stroke-width="1.5"/></svg>
        </button>
        <div class="invalid-feedback">Ingresa tu contraseña.</div>
      </div>

      <button id="btnLogin" class="btn btn-brand w-100">
        <span class="spinner-border spinner-border-sm me-2 d-none" role="status" aria-hidden="true"></span>
        Iniciar sesión
      </button>

      <div id="respuesta" class="mt-2"></div>

      <div class="text-center">
        <a class="btn btn-ghost w-100" href="/registro/">¿No tienes cuenta? Crea una aquí</a>
      </div>
    </div>
  </main>

  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
  <script>
    // Mostrar/ocultar contraseña
    document.querySelectorAll('.toggle-pass').forEach(btn=>{
      btn.addEventListener('click',()=>{
        const input = document.getElementById(btn.dataset.target);
        input.type = input.type === 'password' ? 'text' : 'password';
      });
    });

    // Normaliza para login: envía RUT sin símbolos (como ya hacías)
    function normalizarRutLogin(v){
      return (v || '').toUpperCase().replace(/[^0-9K]/g,''); // quita puntos/guiones/espacios
    }

    function validarCampos({rut, password}){
      let ok = true;
      const setInvalid = (id, cond) => {
        const el = document.getElementById(id);
        if(cond){ el.classList.add('is-invalid'); ok = false; } else { el.classList.remove('is-invalid'); }
      };
      setInvalid('rut', rut.length < 8);           // validación mínima para UX
      setInvalid('password', password.length < 1); // requerido
      return ok;
    }

    const btn = document.getElementById('btnLogin');
    btn.addEventListener('click', iniciarSesion);

    // Enter para enviar
    document.getElementById('loginForm').addEventListener('keydown', (e)=>{
      if(e.key === 'Enter'){ e.preventDefault(); iniciarSesion(); }
    });

    function setLoading(state){
      const sp = btn.querySelector('.spinner-border');
      if(state){ sp.classList.remove('d-none'); btn.setAttribute('disabled','true'); }
      else{ sp.classList.add('d-none'); btn.removeAttribute('disabled'); }
    }

    function iniciarSesion() {
      const rutInput = document.getElementById("rut");
      const rut = normalizarRutLogin(rutInput.value.trim());
      const password = document.getElementById("password").value.trim();

      // Refleja el RUT limpio en el input (para evitar confusiones visuales)
      rutInput.value = rut;

      if(!validarCampos({rut, password})){
        document.getElementById("respuesta").innerHTML =
          `<div class="alert alert-danger mt-1">Revisa los campos marcados.</div>`;
        return;
      }

      setLoading(true);
      axios.post('http://127.0.0.1:8000/api/usuarios/login/', { rut, password })
        .then(response => {
          const usuario = response.data;
          localStorage.setItem("usuario_id", usuario.user_id);
          localStorage.setItem("authToken", usuario.token);
          localStorage.setItem("username", usuario.username);
          sessionStorage.removeItem('motivoPaciente'); // limpia residuo
          window.location.href = "/motivo/";
        })
        .catch(error => {
          const msg = error.response?.data?.error || 'Credenciales inválidas';
          document.getElementById("respuesta").innerHTML =
            `<div class="alert alert-danger mt-2">❌ ${msg}</div>`;
        })
        .finally(()=> setLoading(false));
    }
  </script>
</body>
</html>